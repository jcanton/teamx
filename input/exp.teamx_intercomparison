#!/bin/bash
# ICON
#
# ------------------------------------------
# Copyright (C) 2004-2024, DWD, MPI-M, DKRZ, KIT, ETH, MeteoSwiss
# Contact information: icon-model.org
# See AUTHORS.TXT for a list of authors
# See LICENSES/ for license information
# SPDX-License-Identifier: BSD-3-Clause
# ------------------------------------------
#
#-----------------------------------------------------------------------------
# the namelist filename
atmo_namelist=NAMELIST_${EXPNAME}
#
#-----------------------------------------------------------------------------
# global timing
start_date="2001-01-01T00:00:00Z"
end_date="2001-01-01T00:03:00Z"
#
#-----------------------------------------------------------------------------
# TeamX stuff
#
teamx_folder="${SCRATCH}/teamx/input"
#
# the sounding file (needs to be called `sound_in` for ICON to read it)
add_link_file ${teamx_folder}/soundings_tables/input_sounding_teamx_u10_ridge100 sound_in
#
# the grid file (can have whatever name, see below in `grid_nml`)
atmo_dyn_grid="${teamx_folder}/grid_10240m_x_20480m_res20m.nc"
#
#-----------------------------------------------------------------------------

#-----------------------------------------------------------------------------
#
# write ICON namelist parameters
# ------------------------
# For a complete list see Namelist_overview and Namelist_overview.pdf
#
cat >${atmo_namelist} <<EOF
!
&parallel_nml
 nproma     = ${nproma}
 nblocks_e  = ${nblocks_e}    ! loop number of edge blocks
 nproma_sub = ${nproma_sub} ! loop chunk length for radiation scheme
/
&grid_nml
 dynamics_grid_filename = "${atmo_dyn_grid}"
 is_plane_torus         = .true.
 corio_lat              = 1.0e-4
/
&run_nml
 num_lev              = 250      ! number of full levels of vertical grid
 dtime                = 0.2      ! [s] timestep in seconds
 ltestcase            = .true.   ! run testcase --> testcase_ctl
 ldynamics            = .true.   ! dynamics
 ltransport           = .false.  ! transport
 iforcing             = 3        ! 0: no forcing, 3: NWP forcing
 ntracer              = 0        ! number of tracers - default 0
 ltimer               = .true.
 timers_level         = 10
 msg_level            = 18       ! detailed report during integration
 profiling_output     = 3
 activate_sync_timers = .true.
 output               = "nml"
/
&dynamics_nml
 iequations     = 3
 lcoriolis      = .true.
 lmoist_thdyn   = .false.
 divavg_cntrwgt = 0.50
/
&nonhydrostatic_nml
 ndyn_substeps  = 5          ! number of substeps
 iadv_rhotheta  = 2
 igradp_method  = 3          ! new default
 rayleigh_coeff = 0.00333333 ! Rayleigh coefficient for damping in upper levels
 damp_height    = 3000       ! damping height, keep top 5-10 levels for damping
 divdamp_type   = 3          ! type of divergence damping (default = 3)
 divdamp_order  = 24         ! order of divergence damping (only 24 is implemented in icon4py)
 l_zdiffu_t     = .true.     ! specifies computation of Smagorinsky temperature diffusion
 thslp_zdiffu   = 0.025      ! Smagorinsky diffusion coefficient for temperature
 thhgtd_zdiffu  = 200.0      ! Height for temperature diffusion
/
&diffusion_nml
 hdiff_order        = 5       ! order of nabla operator for diffusion
 lhdiff_w           = .true.  ! diffusion on the vertical wind field
 lhdiff_vn          = .true.
 lhdiff_temp        = .true.
 itype_vn_diffu     = 1       ! reconstruction method used for Smagorinsky diffusion
 lsmag_3d           = .false. ! 3D Smagorinsky diffusion
 itype_t_diffu      = 2       ! discretization of temperature diffusion
 hdiff_efdt_ratio   = 36.0    ! ratio of e-folding time to time step
 hdiff_w_efdt_ratio = 15.0    ! ratio of e-folding time to time step for vertical wind
 hdiff_smag_fac     = 0.015   ! scaling factor for Smagorinsky diffusion
 hdiff_multfac      = 1.0     ! these two are not implemented in icon4py ?!??!?!?!?!
 hdiff_tv_ratio     = 1.0     ! these two are not implemented in icon4py ?!??!?!?!?!
/
&nh_testcase_nml
 nh_test_name = 'teamx'       ! test case identifier
 mount_height  = 100.0        ! height of the mountain
 mount_width   = 10240        ! = 512*20: wave length of the mountain (used gauss3d name to avoid creating a new one)
 th_perturb    = 0.25         ! [K] perturbation on theta
/
&sleve_nml
 min_lay_thckn   = 10.0        ! Layer thickness of lowermost layer
 top_height      = 5000.0      ! Height of model top
 flat_height     = 5000.0      ! Height above which the coordinate surfaces are flat
 stretch_fac     = 0.65        ! Scaling factor for stretching/squeezing the model layer distribution (NOTE: 0.65 for flat and 100m hill, 1.0 for 1000m hill)
 decay_scale_1   = 2000.0      ! Decay scale of large-scale topography component (NOTE: 2000.0 for 0 and 100m hill, 3000.0 for 1000m hill)
/
&nwp_phy_nml
 inwp_gscp       = 0           ! Cloud microphysics and precipitation
 inwp_convection = 0           ! Convection
 inwp_cldcover   = 0           ! Cloud cover scheme for radiation (0: no clouds, only qv)
 inwp_radiation  = 0           ! Radiation
 inwp_satad      = 0           ! Saturation adjustment
 inwp_turb       = 5           ! Vertical diffusion and transfer (5: classical Smagorinsky diffusion)
 inwp_sso        = 0           ! Subgrid scale orographic drag
 inwp_gwd        = 0           ! Non-orographic gravity wave drag
 inwp_surface    = 0           ! Surface scheme
 dt_conv         = 1.0         ! [s] timestep for convection
 dt_ccov         = 1.0         ! [s] timestep for cloud cover
 dt_rad          = 1.0         ! [s] timestep for radiation
 dt_sso          = 1.0         ! [s] timestep for subgrid scale orographic drag
 dt_gwd          = 1.0         ! [s] timestep for non-orographic gravity wave drag
/
&les_nml
 isrfc_type      = 2           ! Surface type (2 = fixed surface fluxes)
 shflx           = 0.12        ! Prescribed surface sensible heat flux
 lhflx           = 0.0         ! Prescribed surface latent heat flux
 psfc            = 1000.0      ! Prescribed surface pressure -- consistent with sounding tables
/
&turbdiff_nml
 lconst_z0      = .true.       ! Prescribe constant roughness length
 const_z0       = 0.1          ! Horizontally homogeneous roughness length
/
&output_nml
 output_filename = '${EXPNAME}_insta'
 output_grid     = .false.
 filetype        = 4
 dom             = -1
 output_start    = "${start_date}"
 output_end      = "${end_date}"
 output_interval = "PT10M00S"
 file_interval   = "PT10M00S"
 include_last    = .true.
 remap           = 0   ! 0: triangular grid, 1: regular grid
 ml_varlist      = 'u','v','w','theta_v','pres','rho','z_ifc',
/
&io_nml
 dt_checkpoint        = 36000 ! [s] trigger new restart file
 lnetcdf_flt64_output = .true.
/
EOF
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
# add standard atmo_non-hydrostatic_files
. ${thisdir}/add_required_atmo_non-hydrostatic_files
#-----------------------------------------------------------------------------
